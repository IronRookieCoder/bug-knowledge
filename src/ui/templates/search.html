{% extends "base.html" %} {% block title %}搜索BUG - {{ super() }}{% endblock %}
{% block content %}
<div class="row">
  <div class="col-md-4">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">搜索BUG</h5>
        <form id="searchForm">
          <div class="mb-3">
            <label for="query" class="form-label">问题描述</label>
            <textarea
              class="form-control"
              id="query"
              name="query"
              rows="3"
            ></textarea>
          </div>

          <div class="mb-3">
            <label for="code" class="form-label">代码片段</label>
            <textarea
              class="form-control"
              id="code"
              name="code"
              rows="3"
            ></textarea>
          </div>

          <div class="mb-3">
            <label for="error_log" class="form-label">错误日志</label>
            <textarea
              class="form-control"
              id="error_log"
              name="error_log"
              rows="3"
            ></textarea>
          </div>

          <div class="mb-3">
            <label for="env_info" class="form-label">环境信息</label>
            <textarea
              class="form-control"
              id="env_info"
              name="env_info"
              rows="2"
            ></textarea>
          </div>

          <div class="mb-3">
            <label for="n_results" class="form-label">返回结果数量</label>
            <input
              type="number"
              class="form-control"
              id="n_results"
              name="n_results"
              value="5"
              min="1"
              max="20"
            />
          </div>

          <button type="submit" class="btn btn-primary">搜索</button>
        </form>
      </div>
    </div>
  </div>

  <div class="col-md-8">
    <div id="results" class="d-none">
      <h3>搜索结果</h3>
      <div id="resultsList"></div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document
    .getElementById("searchForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(this);

      try {
        const response = await fetch("/search", {
          method: "POST",
          body: formData,
        });

        const data = await response.json();

        // 显示结果
        const resultsDiv = document.getElementById("results");
        const resultsList = document.getElementById("resultsList");
        resultsDiv.classList.remove("d-none");

        if (data.results && data.results.length > 0) {
          resultsList.innerHTML = data.results
            .map(
              (bug) => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h5 class="card-title">${bug.title}</h5>
                            <span class="badge bg-primary">相似度: ${(
                              1 - bug.distance
                            ).toFixed(2)}</span>
                        </div>
                        <h6 class="card-subtitle mb-2 text-muted">ID: ${
                          bug.id
                        }</h6>
                        <p class="card-text">${bug.description}</p>
                        
                        <div class="accordion" id="accordion-${bug.id}">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${
                                      bug.id
                                    }">
                                        查看详情
                                    </button>
                                </h2>
                                <div id="collapse-${
                                  bug.id
                                }" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <h6>重现步骤：</h6>
                                        <ol>
                                            ${bug.steps_to_reproduce
                                              .map((step) => `<li>${step}</li>`)
                                              .join("")}
                                        </ol>
                                        
                                        <h6>期望行为：</h6>
                                        <p>${bug.expected_behavior}</p>
                                        
                                        <h6>实际行为：</h6>
                                        <p>${bug.actual_behavior}</p>
                                        
                                        <h6>问题代码：</h6>
                                        <pre><code>${
                                          bug.code_context.code
                                        }</code></pre>
                                        
                                        <h6>错误日志：</h6>
                                        <pre><code>${
                                          bug.error_logs
                                        }</code></pre>
                                        
                                        <h6>环境信息：</h6>
                                        <ul>
                                            <li>运行时环境：${
                                              bug.environment.runtime_env
                                            }</li>
                                            <li>操作系统：${
                                              bug.environment.os_info
                                            }</li>
                                            ${
                                              bug.environment.network_env
                                                ? `<li>网络环境：${bug.environment.network_env}</li>`
                                                : ""
                                            }
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `
            )
            .join("");
        } else {
          resultsList.innerHTML =
            '<div class="alert alert-warning">未找到相关BUG记录</div>';
        }
      } catch (error) {
        console.error("Error:", error);
        alert("搜索失败，请重试");
      }
    });
</script>
{% endblock %}
