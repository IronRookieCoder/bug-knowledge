#!/usr/bin/env bash

# 错误处理
set -e

# 检查conda是否安装
if ! command -v conda &> /dev/null; then
    echo "Error: conda not found, please install Miniconda or Anaconda first"
    exit 1
fi

echo "Detecting operating system..."

# Windows环境（Git Bash、Cygwin 或 MSYS）
if [[ "$OSTYPE" == "msys"* ]] || [[ "$OSTYPE" == "cygwin"* ]] || [[ "$OSTYPE" == "win"* ]]; then
    echo "Windows environment detected"
    
    # Windows环境下的conda路径处理
    if [[ -z "${CONDA_PATH}" ]]; then
        # 尝试常见的conda安装路径
        if [ -d "/c/Users/$USER/miniconda3" ]; then
            CONDA_PATH="/c/Users/$USER/miniconda3"
        elif [ -d "/c/Users/$USER/Anaconda3" ]; then
            CONDA_PATH="/c/Users/$USER/Anaconda3"
        elif [ -d "/d/conda" ]; then
            CONDA_PATH="/d/conda"
        else
            echo "Error: conda path not found, please set CONDA_PATH environment variable"
            exit 1
        fi
    fi
    
    echo "Creating Conda environment..."
    cmd //c "conda env create -f environment.yml"
    
    echo "Activating environment..."
    cmd //c "conda activate bug-knowledge"
    
# Linux/Unix环境
else
    echo "Linux/Unix environment detected"
    
    # 确保脚本有执行权限
    if [ ! -x "$(command -v conda)" ]; then
        echo "Error: conda command not accessible, please check conda installation"
        exit 1
    fi
    
    echo "Creating Conda environment..."
    conda env create -f environment.yml
    
    echo "Activating environment..."
    source "$(conda info --base)/etc/profile.d/conda.sh"
    conda activate bug-knowledge
fi

# 创建必要的目录
mkdir -p logs data/annoy

echo "Environment setup complete!"
echo "To activate the environment, run: conda activate bug-knowledge"